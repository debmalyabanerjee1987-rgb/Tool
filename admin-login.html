<div id="admin-login" style="max-width:400px; margin:20px auto; background:#f3f4f6; padding:15px; border-radius:8px;">
  <h3>🔐 Admin Login</h3>
  <input type="password" id="adminPassword" placeholder="Enter Admin Password">
  <button onclick="adminLogin()">Login</button>
  <p id="login-status" style="color:#dc2626; font-size:0.9em;"></p>
</div>

<div id="admin-tools" style="display:none; max-width:800px; margin:20px auto; background:#fff3cd; padding:10px; border-radius:8px;">
  <h3>🛠 Admin Tools</h3>
  <button onclick="bulkDelete()">🗑 Bulk Delete</button>
  <button onclick="toggleSort()">↕ Toggle Sort (New/Old)</button>
  <button onclick="adminLogout()">🚪 Logout</button>
</div>
    <!-- Comment Form -->
    <div class="comment-box">
      <input type="text" id="username" placeholder="Your Name *" required>
      <input type="email" id="email" placeholder="Your Email *" required>
      <textarea id="commentText" placeholder="Your Comment (max 250 words)" required></textarea>
      <input type="file" id="avatar" accept="image/*">
      <button onclick="addComment()">Post Comment</button>
    </div>

    <!-- Comments List -->
    <div id="comments"></div>
  </section>

  <footer>
    <p>© 2025 Shubhankar Banerjee | All Rights Reserved</p>
  </footer>

  <script>
    let comments = JSON.parse(localStorage.getItem("comments")) || [];
    let blockedUsers = JSON.parse(localStorage.getItem("blockedUsers")) || [];
    let sortOrder = "new"; 
    let isAdmin = localStorage.getItem("isAdmin") === "true";

    // 🔑 Hash of "@Shubhankar16"
    const ADMIN_HASH = "6eb507f948f1c4a95316672a123c4927ad070bf9c4324d501af3f30c7b5960e5";

    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function adminLogin() {
      const pass = document.getElementById("adminPassword").value;
      const hash = await hashPassword(pass);
      if (hash === ADMIN_HASH) {
        isAdmin = true;
        localStorage.setItem("isAdmin", "true");
        document.getElementById("admin-login").style.display = "none";
        renderComments();
      } else {
        document.getElementById("login-status").innerText = "❌ Wrong password!";
      }
    }

    function adminLogout() {
      isAdmin = false;
      localStorage.setItem("isAdmin", "false");
      document.getElementById("admin-login").style.display = "block";
      renderComments();
    }

    // Auto-remove old comments >1 year
    function cleanupOldComments() {
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
      comments = comments.filter(c => new Date(c.date) > oneYearAgo);
      localStorage.setItem("comments", JSON.stringify(comments));
    }
    cleanupOldComments();

    function renderComments() {
      const container = document.getElementById("comments");
      container.innerHTML = "";

      let sortedComments = [...comments];
      sortedComments.sort((a, b) => {
        return sortOrder === "new" ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date);
      });

      sortedComments.forEach((c, index) => {
        let div = document.createElement("div");
        div.className = "comment-card";
        let avatar = c.avatar ? c.avatar : "https://via.placeholder.com/48";

        div.innerHTML = `
          ${isAdmin ? `<input type="checkbox" class="select-comment" data-index="${index}">` : ""}
          <img src="${avatar}" alt="Avatar">
          <div class="comment-content">
            <div class="meta">${new Date(c.date).toLocaleString()}</div>
            <strong>${c.user} (${c.email})</strong>
            <p>${c.text}</p>
        `;

        if (!c.approved) {
          if (isAdmin) {
            div.innerHTML += `
              <p style="color:#b91c1c;"><em>Pending approval...</em></p>
              <div class="reply-box">
                <button onclick="approveComment(${index})">✅ Approve</button>
                <button onclick="deleteComment(${index})">🗑 Delete</button>
                <button onclick="blockUser('${c.email}')">🚫 Block User</button>
              </div>
            `;
          } else {
            div.innerHTML += `<p style="color:#b91c1c;"><em>Pending approval...</em></p>`;
          }
        } else {
          if (c.reply) {
            div.innerHTML += `
              <div class="admin-reply">
                <img src="https://via.placeholder.com/48/FFA500/fff?text=A" alt="Admin">
                <div class="comment-content">
                  <div class="meta">Admin Reply</div>
                  <p><strong>Admin:</strong> ${c.reply}</p>
                </div>
              </div>`;
          }
          if (isAdmin) {
            div.innerHTML += `
              <div class="reply-box">
                <textarea id="reply-${index}" placeholder="Admin reply..."></textarea>
                <button onclick="addReply(${index})">Reply as Admin</button>
                <button onclick="deleteComment(${index})">🗑 Delete</button>
                <button onclick="blockUser('${c.email}')">🚫 Block User</button>
              </div>
            `;
          }
        }

        div.innerHTML += `</div>`;
        container.appendChild(div);
      });

      document.getElementById("admin-tools").style.display = isAdmin ? "block" : "none";
    }

    function addComment() {
      const user = document.getElementById("username").value.trim();
      const email = document.getElementById("email").value.trim();
      const text = document.getElementById("commentText").value.trim();
      const fileInput = document.getElementById("avatar");

      if (!user || !email || !text) {
        return alert("Name, Email and Comment are required!");
      }
      if (blockedUsers.includes(email)) {
        return alert("You are blocked from commenting.");
      }

      const wordCount = text.split(/\s+/).filter(w => w.length > 0).length;
      if (wordCount > 250) {
        return alert("Your comment exceeds the 250-word limit. Please shorten it.");
      }

      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          saveComment(user, email, text, e.target.result);
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        saveComment(user, email, text, "");
      }
    }

    function saveComment(user, email, text, avatar) {
      comments.push({ user, email, text, avatar, reply: "", date: new Date().toISOString(), approved: false });
      localStorage.setItem("comments", JSON.stringify(comments));
      renderComments();
    }

    function addReply(index) {
      const replyText = document.getElementById("reply-" + index).value.trim();
      if (!replyText) return alert("Reply cannot be empty");
      comments[index].reply = replyText;
      localStorage.setItem("comments", JSON.stringify(comments));
      renderComments();
    }

    function approveComment(index) {
      comments[index].approved = true;
      localStorage.setItem("comments", JSON.stringify(comments));
      renderComments();
    }

    function deleteComment(index) {
      if (confirm("Are you sure you want to delete this comment?")) {
        comments.splice(index, 1);
        localStorage.setItem("comments", JSON.stringify(comments));
        renderComments();
      }
    }

    function bulkDelete() {
      const checkboxes = document.querySelectorAll(".select-comment:checked");
      if (checkboxes.length === 0) return alert("No comments selected.");
      if (!confirm("Delete selected comments?")) return;
      const indexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
      comments = comments.filter((c, i) => !indexes.includes(i));
      localStorage.setItem("comments", JSON.stringify(comments));
      renderComments();
    }

    function blockUser(email) {
      if (!blockedUsers.includes(email)) {
        blockedUsers.push(email);
        localStorage.setItem("blockedUsers", JSON.stringify(blockedUsers));
        alert("User blocked: " + email);
      }
    }

    function toggleSort() {
      sortOrder = sortOrder === "new" ? "old" : "new";
      renderComments();
    }

    if (isAdmin) {
      document.getElementById("admin-login").style.display = "none";
    }
    renderComments();
  </script>
